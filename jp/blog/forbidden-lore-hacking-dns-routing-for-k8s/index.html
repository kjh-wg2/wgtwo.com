<!doctype html>
<html lang="jp" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Forbidden lore: hacking DNS routing for k8s | add customers nav (#164)</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.wgtwo.com//jp/img/wgtwo-logo-white-bg.png"><meta data-rh="true" name="twitter:image" content="https://www.wgtwo.com//jp/img/wgtwo-logo-white-bg.png"><meta data-rh="true" property="og:url" content="https://www.wgtwo.com//jp/blog/forbidden-lore-hacking-dns-routing-for-k8s/"><meta data-rh="true" name="docusaurus_locale" content="jp"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="jp"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="og:description" content="We help mobile operators innovate at scale, reduce cost and dive into new revenue streams - by building a mobile core network from the ground up and delivering it as-a-service."><meta data-rh="true" name="og:image" content="/img/wgtwo-logo-white-bg.png"><meta data-rh="true" name="keywords" content="mvne, private network, epc, 5G core, mvno, IMS core, mobile core, evolved packet core epc, mvno core, core as a service&#x27;"><meta data-rh="true" property="og:title" content="Forbidden lore: hacking DNS routing for k8s | add customers nav (#164)"><meta data-rh="true" name="description" content="At WG2 we’re coming close to having everything running in Kubernetes, which means that almost everything we deploy needs to be pulled from a registry. We have run our own local registry for some time now, to host both locally-built images and cached images from Docker Hub."><meta data-rh="true" property="og:description" content="At WG2 we’re coming close to having everything running in Kubernetes, which means that almost everything we deploy needs to be pulled from a registry. We have run our own local registry for some time now, to host both locally-built images and cached images from Docker Hub."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2020-12-11T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://www.linkedin.com/in/annaken,https://www.linkedin.com/in/hihrig/,https://www.linkedin.com/in/mattlong/,https://www.linkedin.com/in/yangrunenberger/"><meta data-rh="true" property="article:tag" content="dns,nginx,kubernetes,infrastructure"><link data-rh="true" rel="icon" href="/jp/img/favicons/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.wgtwo.com//jp/blog/forbidden-lore-hacking-dns-routing-for-k8s/"><link data-rh="true" rel="alternate" href="https://www.wgtwo.com//blog/forbidden-lore-hacking-dns-routing-for-k8s/" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.wgtwo.com//jp/blog/forbidden-lore-hacking-dns-routing-for-k8s/" hreflang="jp"><link data-rh="true" rel="alternate" href="https://www.wgtwo.com//blog/forbidden-lore-hacking-dns-routing-for-k8s/" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/jp/blog/rss.xml" title="add customers nav (#164) RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/jp/blog/atom.xml" title="add customers nav (#164) Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-114662288-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><link rel="stylesheet" href="/jp/assets/css/styles.a45bfd52.css">
<link rel="preload" href="/jp/assets/js/runtime~main.3259552e.js" as="script">
<link rel="preload" href="/jp/assets/js/main.7249d4bb.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/jp/"><div class="navbar__logo"><img src="/jp/img/logo.svg" alt="wgtwo Logo" class="themedImage_ToTc themedImage--light_HNdA" height="32px" width="191px"><img src="/jp/img/logo_white.svg" alt="wgtwo Logo" class="themedImage_ToTc themedImage--dark_i4oU" height="32px" width="191px"></div></a><a class="navbar__item navbar__link" target="_self" href="/jp/technology/">Technology</a><a class="navbar__item navbar__link" target="_self" href="/jp/product-ecosystem/">Product Ecosystem</a><div class="navbar__item dropdown dropdown--hoverable"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/jp/">Showcase</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/jp/">Vimla</a></li><li><a class="dropdown__link" href="/jp/">CKH IOD</a></li><li><a class="dropdown__link" href="/jp/">MKI</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/jp/careers/">Join the Team 🎉</a><a class="navbar__item navbar__link" href="/jp/blog/">Blog</a><a class="navbar__item navbar__link sign-up" href="/jp/contact/">Talk to us</a><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/how-product-bundling-simplifies-distribution/">How product bundling simplifies the distribution challenge</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/atos-teams-with-wgtwo/">Atos and Working Group Two to deliver core-as-a-service to mobile operators worldwide</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/telco-tech-talk-telenor-aws/">Telco Tech Talk: Three CEOs on the future of the telecom industry, moving to the cloud and transforming company cultures</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/evolution-of-mobile-core/">Q&amp;A with Stephane: The evolution of the mobile core</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/releasing-sip-breakout-api/">Hello abundance, bye-bye complexity: With this new public API you can plug multiple switchboards into the call path - without knowing what a call path is</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/what-we-build-right-now-june22/">What we&#x27;re building on the platform right now: 5GSA, 5GNSA, OCS, content filtering, VoNR, VoLTE on sXGP, VoLTE roaming, support for PBX from Telavox... and more </a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/no-need-for-a-business-case/">The business case for not needing a business case</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/nortel-ecosystem/">Building a product ecosystem: Here&#x27;s a question mobile operators need to hear more often.</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/vxt-joins-marketplace/">Vxt is on a mission to eradicate boring tasks. Now they’re joining Working Group Two’s product marketplace.</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/voxist-to-join-marketplace/">Voxist to join the Working Group Two marketplace</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/releasing-our-first-grpc-apis/">We are releasing our first production-ready gRPC APIs!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/new-website/">How I leveraged the 80/20 principle to rebuild wgtwo.com</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/manual-on-me-matt-long/">Manual on Me: Matt Long</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/please-dont-leave-a-message-after-the-beep/">Don&#x27;t leave a message after the beep</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/the-specs-behind-the-specs-part-1/">The specs behind the specs part 1</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/log4j-security-vulnerability/">Zero-day vulnerabilities - Log4j</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/ckh-iod-wg2-public-cloud/">CKH IOD selects Working Group Two for public cloud core network</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/mitsui-knowledge-industry-mki-private-networks-business/">Mitsui Knowledge Industry (MKI) to develop private networks business</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/kafka-timers/">Kafka timers</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/mqtt-event-bridge/">Changing the color of your bulbs: The fancy way</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/jp/blog/forbidden-lore-hacking-dns-routing-for-k8s/">Forbidden lore: hacking DNS routing for k8s</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/were-all-grownups-here/">We&#x27;re all grownups here</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/hackdays-october-2020/">October Virtual Hackdays</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/what-is-a-short-message/">What the heck is a short message?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/a-new-hope-for-products-in-telecom/">A new hope for products in telecom</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/building-software-for-a-telecom-core-network/">Building software for a telecom core network</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/choosing-erlang-formatter/">Choosing an Erlang formatter</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/vowifi-imsi-leak/">VoWifi leaking IMSI</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/extending-k8s/">Extending Kubernetes for our needs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/metrics-unlimited-thanos/">Towards observability nirvana: infinite metric retention with Thanos</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/replacing-jenkins-with-concourse/">We killed the butler: Replacing Jenkins with Concourse</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/jp/blog/hacking-dark-themes-with-css-blend-modes/">Hacking dark themes with CSS blend modes</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">Forbidden lore: hacking DNS routing for k8s</h1><div class="container_mt6G margin-vert--md"><time datetime="2020-12-11T00:00:00.000Z" itemprop="datePublished">December 11, 2020</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/annaken" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/author-photos/ak.jpg" alt="Anna Kennedy"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/annaken" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Anna Kennedy</span></a></div><small class="avatar__subtitle" itemprop="description">Tech Lead for Cloud and Edge Infrastructure</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/hihrig/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/author-photos/hi.jpg" alt="Holger Ihrig"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/hihrig/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Holger Ihrig</span></a></div><small class="avatar__subtitle" itemprop="description">Software Engineer for Session Management &amp; Protocol Termination</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/mattlong/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/author-photos/mtl-li.jpg" alt="Matt Long"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/mattlong/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Matt Long</span></a></div><small class="avatar__subtitle" itemprop="description">Engineering Manager for Edge, Cloud and Security</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/yangrunenberger/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/author-photos/yg.jpg" alt="Yan Grunenberger"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/yangrunenberger/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Yan Grunenberger</span></a></div><small class="avatar__subtitle" itemprop="description">Software Engineer for Session Management &amp; Protocol Termination</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>At WG2 we’re coming close to having everything running in Kubernetes, which means that almost everything we deploy needs to be pulled from a registry. We have run our own local registry for some time now, to host both locally-built images and cached images from Docker Hub.</p><p>We recently decided to improve the registry solution by implementing <a href="https://goharbor.io/" target="_blank" rel="noopener noreferrer">Harbor</a> to scan images for vulnerabilities on upload, and replicating the registry into each of our multiple environments and regions. This would both eliminate Harbor as a single point of failure, and allow each cluster to pull images locally to minimise data transfer costs through the NAT gateway.</p><p>The overall workflow would look something like:</p><ul><li>images are built and uploaded to Harbor</li><li>Harbor scans for vulnerabilities and pushes images to a private registry</li><li>this registry is replicated to a read-only registry</li><li>the read-only registry is replicated to all environments and regions</li><li>the Kubernetes cluster in each environment deploys from the local read-only registry</li></ul><p><img loading="lazy" alt="Workflow" src="/jp/assets/images/multiregion-13365939553782c33c21219d2e21d410.jpg" width="736" height="331" class="img_ev3q"></p><p>Harbor has to live somewhere, so we decided it should live in the dev environment, close to the CI system that builds the majority of our images. However, container image names contain the registry location that they are pulled from / pushed to, eg <code>reg.wgtwo.com/infra/logstash</code>. Therefore in the dev environment we have to find a way to deal with the fact that we want users and the CI system to push to Harbor, but we also want Kubernetes to pull images from the read-only registry.</p><p>So the main problem becomes: if the image name includes the url <code>reg.wgtwo.com</code>, how to make that point to two different places depending on usage?</p><h1>Solution 1: DNS</h1><p>In non-dev environments, the obvious solution is to redirect <code>reg.wgtwo.com -&gt; read-only-registry</code> in Kubernetes CoreDNS. But in dev, we need different services to go to different places. The DNS model thus needs to look like:</p><p><img loading="lazy" alt="DNS" src="/jp/assets/images/dnsresolution-d0a90858bbeab60834fd5f80b85a9ba5.jpg" width="702" height="483" class="img_ev3q"></p><p>In other words,</p><ul><li><code>Route53</code> sets <code>reg.wgtwo.com -&gt; harbor</code></li><li>K8s coreDNS sets <code>reg.wgtwo.com -&gt; read-only-registry</code></li><li>CI (Concourse) bypasses cluster lookup and goes to <code>Route53</code> instead, such that <code>reg.wgtwo.com -&gt; harbor</code></li></ul><p>We initially deployed a DNS sidecar to the CI system, but with multiple Concourse pods we got multiple sidecars and we really only needed one, plus we had to manipulate Concourse’s internal DNS cache (<code>CONCOURSE_GARDEN_DNS_SERVER</code>) but that broke DNS between Concourse and everything else in the cluster. Replacing the sidecar with a DNS pod in the CI namespace worked better, although then all the CI jobs needed to be updated to use that new pod as their nameserver.</p><p><img loading="lazy" alt="Sleight of hand" src="/jp/assets/images/sleight-of-hand-fbae8de3401322c1485949179d2a6f32.gif" width="455" height="248" class="img_ev3q"></p><p>However at this point we realised that although we want to deploy pods into Kubernetes, the process that does the deploying lives on the Kubernetes nodes, outside of cluster scope.
We don’t do any config management on the nodes, we just let <a href="https://github.com/kubernetes/kops" target="_blank" rel="noopener noreferrer">kOps</a> deploy everything that Kubernetes needs for a cluster, so we were reluctant to introduce an entirely different system just for managing one <code>resolv.conf</code> file. Also the concentric DNS setup would have a very wide scope and be somewhat difficult to debug. Maybe this was a problem better resolved using some clever nginx routing?</p><h1>Solution 2: nginx</h1><p>If we could find some way of differentiating the Harbor traffic from read-only-registry traffic, we could let nginx route requests to the right place.</p><iframe src="https://giphy.com/embed/QaPkV29BJh3gI" width="240" height="177" frameborder="0" class="giphy-embed" allowfullscreen=""></iframe><h1>Solution 2a: nginx routes traffic on IP</h1><ul><li>Traffic from the outside world plus traffic from Concourse needs to go to Harbor.</li><li>Traffic from the Kubernetes cluster needs to go to the read-only-registry.</li></ul><p>The <a href="https://nginx.org/en/docs/http/ngx_http_geo_module.html" target="_blank" rel="noopener noreferrer">nginx geo module</a> sounded like a good idea, where we could set our internal subnet ranges to go to the read-only-registry. However getting the ingress annotations to put this config in the right place turned out to be challenging, since it needs to go outside of both <code>http snippet</code> and <code>server snippet</code> blocks. But before we dug further into this issue we realised that all of the traffic to nginx would arrive via the internet gateway, meaning we wouldn’t see source IP anyway.</p><h1>Solution 2b: nginx routes on custom header</h1><p>The new <code>canary</code> feature in nginx makes this kind of routing very easy - traffic that matches a certain criteria gets sent to a different backend. We could use a custom header such as <code>ro-reg</code> to send internal traffic to the read-only registry.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">annotations:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  nginx.ingress.kubernetes.io/canary: &quot;true&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  nginx.ingress.kubernetes.io/canary-by-header: &quot;ro-reg&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The docker (client) config has an <a href="https://github.com/docker/cli/blob/master/man/docker-config-json.5.md" target="_blank" rel="noopener noreferrer">HttpHeaders</a> section, so it would be easy enough to add this section to all of our image-pull secrets, meaning all internal pulls - but nothing else - should go to the read-only registry.</p><p>We had to rearrange things a little in order to terminate SSL on nginx and not at the registry so that nginx would be able to read the headers, but that was straightforward.</p><p>In our initial tests from the laptop, this worked great. However it quickly transpired that this was the only place it worked from. Where we needed it to work from - the Kubernetes nodes - didn’t run Docker, they run <code>docker-shim</code> on top of <code>containerd</code>, and <code>HttpHeaders</code> <a href="https://github.com/containerd/cri/issues/1400" target="_blank" rel="noopener noreferrer">are not implemented yet</a>. Back to the drawing board.</p><h1>Solution 2c: nginx routes on auth header</h1><p>Getting nervous that we’d used a week to get nothing working, we started clutching at some very hacky straws. Even if docker-shim doesn’t send custom headers, we could see it sending auth headers, and we have different login details for Harbor versus the read-only registry. We wondered if we could route on the auth hash, postponing entirely the discussion about whether we should do such a horrible thing, or the security implications of having the auth hash in a plaintext nginx config.</p><iframe src="https://giphy.com/embed/I8RMi1UY8cEKs" frameborder="20px" class="giphy-embed" allowfullscreen=""></iframe><p>We soon discovered that this solution was also never going to work. In Kubernetes, it is the <code>kubelet</code> process that does the image pull at the start of a pod deployment, and after some wiresharking it turns out that the very first thing kubelet does is make an unauthenticated call to the <code>registry/v2</code> endpoint to fetch metadata which it then uses to begin authentication.</p><p>This is expected behaviour for a docker registry, <a href="https://docs.docker.com/registry/spec/auth/token/" target="_blank" rel="noopener noreferrer">according to documentation</a>, but with nginx routing on auth header, it meant that the initial call was routed to Harbor which sent back an auth URL also for Harbor, and thus kubelet never even arrived at the read-only registry, let alone managed to authenticate.</p><h1>Aside: other issues with headers</h1><p>During this debugging session we also realised that we’d been creating image-pull secrets in Kubernetes with both <code>.dockercfg</code> and <code>.dockerconfigjson</code>, not realising that <code>.dockercfg</code> <a href="https://github.com/moby/moby/pull/12009" target="_blank" rel="noopener noreferrer">is the old format</a> and that <code>.dockercfg</code> likely does not support HttpHeaders at all.</p><p>Kubelet <a href="https://github.com/Kubernetes/Kubernetes/blob/e1fd2d7ff57af153023347d72d17226effd917c8/pkg/credentialprovider/config.go#L44" target="_blank" rel="noopener noreferrer">does support HttpHeaders</a>, but relies on the underlying container runtime to also support them - which is not the case for containerd.</p><p>Additionally, when creating a Kubernetes secret containing <code>.dockerconfigjson</code>, it appears that it is very important that there is no whitespace in the secret, or authentication will fail.</p><h1>Solution 2d: route on some other inherent header</h1><p>As one final attempt at making nginx routing work, we looked for other headers being sent, but there was no single header that let us differentiate between kubelet, laptop, and Concourse.</p><p>Kubelet sends a useragent of either <code>docker</code> or <code>go-http-agent</code> (depending on whether the call is the initial one or a retrial) and filtering on <code>go-http-agent</code> also catches Concourse requests, rendering it useless for this task. We were also worried it might end up catching all sorts of unintended cases since we have quite a lot of <code>go</code>-based applications in our ecosystem.</p><p>We took a moment to mourn the loss of our nginx idea, and went back to a DNS solution.</p><p><img loading="lazy" alt="Mourn" src="/jp/assets/images/pulpfiction-14c68561ce1cdd95a2ad42f3fde27b1e.jpg" width="800" height="450" class="img_ev3q"></p><h1>Solution 3: DNS, again</h1><p>We put the DNS solution back in place again, where</p><ul><li><code>Route53</code> sets <code>reg.wgtwo.com -&gt; harbor</code></li><li>K8s nodes set <code>reg.wgtwo.com -&gt; read-only-registry</code></li><li>K8s coreDNS sets <code>reg.wgtwo.com -&gt; read-only-registry</code></li><li>CI runs an additional coreDNS pod setting <code>reg.wgtwo.com -&gt; harbor</code></li><li>Concourse uses CI coreDNS pod to set <code>reg.wgtwo.com -&gt; harbor</code></li></ul><p>Which brought us back to the problem that was still there: how to update <code>/etc/resolv.conf</code> on the nodes. In the continued absence of config management, we hit upon the wonderful hack of using a privileged pod daemonset to manage the config for us via systemd.</p><p>The privileged pod on each node would write a new config file to <code>/etc/systemd/resolvd.conf</code>, and then restart the systemd service to update the running resolvd process.</p><p>This would thus control configuration on the Kubernetes node from inside of Kubernetes, which is admittedly morally wrong but also works really well. It also keeps the configuration alongside all the rest of our configuration instead of hidden away somewhere new.</p><p><img loading="lazy" alt="wheel change" src="/jp/assets/images/wheelchange-57e19e4d177f74c50d800c3268440f30.gif" width="500" height="282" class="img_ev3q"></p><p>A future solution might be to implement some kind of local DNS server/cache on each node, but for now we’ll settle for a working system and a huge increase in knowledge about the inner workings of many of our components.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/jp/blog/tags/dns/">dns</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/jp/blog/tags/nginx/">nginx</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/jp/blog/tags/kubernetes/">kubernetes</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/jp/blog/tags/infrastructure/">infrastructure</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/working-group-two/wgtwo.com/edit/main/blog/../blog/2020-12-11-forbidden-lore-hacking-dns-routing-for-k8s.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/jp/blog/mqtt-event-bridge/"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Changing the color of your bulbs: The fancy way</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/jp/blog/were-all-grownups-here/"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">We&#x27;re all grownups here</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">add customers nav (#164)</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docs.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">API Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://console.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Console Login<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://support.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Customer Support<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">add customers nav (#164)</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/docs/about/introduction/">About</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/docs/case-studies/mvnx/">Case Studies</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/team/">Team</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/careers/">Careers</a></li><li class="footer__item"><a href="https://www.wgtwo.com/jp" target="_blank" rel="noopener noreferrer" class="footer__link-item">gk.wgtwo.com 合同会社<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">add customers nav (#164)</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/security/">Security Overview</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/docs/technology/security-whitepaper/">Security Whitepaper</a></li><li class="footer__item"><a href="https://trust.wgtwo.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Trust Report<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/privacy/">Privacy Notice</a></li></ul></div><div class="col footer__col"><div class="footer__title">add customers nav (#164)</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/docs/about/media-and-analysts/">Media &amp; Analysts</a></li><li class="footer__item"><a href="https://twitter.com/workinggrouptwo" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/working-group-two" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://linkedin.com/company/wgtwo" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/jp/contact/">Contact Us</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a class="footerLogoLink_BH7S" href="/jp/"><img src="/jp/img/logo_white.svg" alt="wgtwo Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo" width="191px" height="32px"><img src="/jp/img/logo_white.svg" alt="wgtwo Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" width="191px" height="32px"></a></div><div class="footer__copyright">© 2022 Working Group Two AS</div></div></div></footer></div>
<script src="/jp/assets/js/runtime~main.3259552e.js"></script>
<script src="/jp/assets/js/main.7249d4bb.js"></script>
</body>
</html>